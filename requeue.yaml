version: "3"

vars:
  NAME: sevberg
  COUNTRIES: [DEU, USA, CHN]
  NUM: 3
  NOW:
    bash: date
  SOME_NUM:
    py: |
      import math
      import json
      print(json.dumps({ "{{NAME}}": math.sqrt( {{NUM}} )}))

tasks:
  prepare_country:
    vars:
      iso3: DEU
    label: "prepare_country[{{iso3}},{{NAME}}]"
    steps:
      - "echo PREPARING: {{iso3}}"
      - "echo $(pwd)"
      - bash: "touch data/prepared_{{iso3}}-{{NAME}}.output"
        if:
          - '"dogs" = "{{NOW}}"'
      # - command: touch data/prepared_{{iso3}}.csv
      #   store: newvar
    inputs:
      - data/input_{{iso3}}.csv
    outputs:
      - data/prepared_{{iso3}}-{{NAME}}.output
    forcing: Inherit

  analyze_country:
    vars:
      iso3: USA
    label: "analyze_country={{iso3}}"
    steps:
      - task: prepare_country
      - "echo ANALYZING: {{iso3}}"
    #     map_over:
    #       iso3: iso3
    #       NAME: COUNTRIES
    #   - 'echo "ANALYZING: {{iso3}}"'
    # inputs:
    #   - data/prepared_{{iso3}}.csv
    # outputs:
    #   - data/analyzed_{{iso3}}.csv
  analyze_all:
    steps:
      - task: analyze_country
        over:
          iso3: "{{COUNTRIES}}"
