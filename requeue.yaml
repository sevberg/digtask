version: "3"

vars:
  NAME: sevberg
  COUNTRIES: [DEU, USA, CHN]
  NUM: 3
  NOW:
    bash: date
  SOME_NUM:
    py: |
      import math
      import json
      print(json.dumps({ "{{NAME}}": math.sqrt( {{NUM}} )}))

tasks:
  prepare_country:
    # default:
    vars:
      iso3: DEU
    label: "prepare_country[{{iso3}},{{NAME}}]"
    steps:
      - "echo PREPARING: {{iso3}}"
      - "echo $(pwd)"
      - bash: "touch data/prepared_{{iso3}}-{{NAME}}.output"
        if:
          - '"dogs" = "{{NOW}}"'
      #   store: newvar
    inputs:
      - data/input_{{iso3}}.csv
    outputs:
      - data/prepared_{{iso3}}-{{NAME}}.output
    forcing: Inherit

  analyze_country:
    vars:
      iso3: GRB
    label: "analyze_country={{iso3}}"
    steps:
      - parallel:
          # - "sleep 5"
          # - "sleep 5"
          - "sleep 1"
          - task: prepare_country
      - 'echo "ANALYZING: {{iso3}}"'

  analyze_all:
    steps:
      - task: analyze_country
        over:
          iso3: "{{COUNTRIES}}"
